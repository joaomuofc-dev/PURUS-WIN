#Requires -Version 5.1

<#
.SYNOPSIS
    Script de instala√ß√£o do PurusWin - Ferramenta CLI para T√©cnicos de TI

.DESCRIPTION
    Este script baixa e instala automaticamente a vers√£o mais recente do PurusWin
    do GitHub Releases, com verifica√ß√£o de integridade e op√ß√µes de configura√ß√£o.

.PARAMETER AddToPath
    Adiciona C:\Tools\PurusWin ao PATH do sistema

.PARAMETER CreateDesktopShortcut
    Cria um atalho na √Årea de Trabalho para o PurusWin.exe

.PARAMETER Simulate
    Executa em modo simula√ß√£o - mostra o que seria feito sem executar

.EXAMPLE
    .\install.ps1
    Instala√ß√£o b√°sica do PurusWin

.EXAMPLE
    .\install.ps1 -AddToPath -CreateDesktopShortcut
    Instala√ß√£o completa com PATH e atalho na √°rea de trabalho

.EXAMPLE
    .\install.ps1 -Simulate
    Simula a instala√ß√£o sem executar

.NOTES
    Autor: PurusWin Team
    Vers√£o: 1.0.0
    Requer: PowerShell 5.1+, Privil√©gios de Administrador (para PATH)
#>

[CmdletBinding()]
param(
    [Parameter(HelpMessage = "Adiciona C:\Tools\PurusWin ao PATH do sistema")]
    [switch]$AddToPath,
    
    [Parameter(HelpMessage = "Cria atalho na √Årea de Trabalho")]
    [switch]$CreateDesktopShortcut,
    
    [Parameter(HelpMessage = "Executa em modo simula√ß√£o")]
    [switch]$Simulate
)

# Configura√ß√µes
$script:Config = @{
    GitHubRepo = "joaomuofc-dev/PURUS-WIN"
    DownloadUrl = "https://github.com/joaomuofc-dev/PURUS-WIN/releases/latest/download/PurusWin.zip"
    HashUrl = "https://github.com/joaomuofc-dev/PURUS-WIN/releases/latest/download/PurusWin.zip.sha256"
    TempPath = "$env:TEMP\PurusWin.zip"
    HashTempPath = "$env:TEMP\PurusWin.zip.sha256"
    InstallPath = "C:\Tools\PurusWin"
    ExecutableName = "PurusWin.exe"
}

# Fun√ß√µes auxiliares
function Write-ColorMessage {
    param(
        [string]$Message,
        [string]$Color = "White",
        [string]$Prefix = "",
        [switch]$NoNewline
    )
    
    $fullMessage = if ($Prefix) { "$Prefix $Message" } else { $Message }
    
    if ($NoNewline) {
        Write-Host $fullMessage -ForegroundColor $Color -NoNewline
    } else {
        Write-Host $fullMessage -ForegroundColor $Color
    }
}

function Write-Success {
    param([string]$Message)
    Write-ColorMessage -Message $Message -Color "Green" -Prefix "‚úÖ"
}

function Write-Info {
    param([string]$Message)
    Write-ColorMessage -Message $Message -Color "Cyan" -Prefix "‚ÑπÔ∏è"
}

function Write-Warning {
    param([string]$Message)
    Write-ColorMessage -Message $Message -Color "Yellow" -Prefix "‚ö†Ô∏è"
}

function Write-Error {
    param([string]$Message)
    Write-ColorMessage -Message $Message -Color "Red" -Prefix "‚ùå"
}

function Write-Progress {
    param([string]$Message)
    Write-ColorMessage -Message $Message -Color "Magenta" -Prefix "üîÑ"
}

function Test-AdminPrivileges {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Get-FileHash256 {
    param([string]$FilePath)
    
    try {
        $hash = Get-FileHash -Path $FilePath -Algorithm SHA256
        return $hash.Hash.ToLower()
    }
    catch {
        Write-Error "Erro ao calcular hash do arquivo: $($_.Exception.Message)"
        return $null
    }
}

function Download-File {
    param(
        [string]$Url,
        [string]$OutputPath,
        [string]$Description = "arquivo"
    )
    
    try {
        Write-Progress "Baixando $Description de $Url..."
        
        if ($Simulate) {
            Write-Info "[SIMULA√á√ÉO] Baixaria $Description para $OutputPath"
            return $true
        }
        
        # Usar WebClient para download com progress
        $webClient = New-Object System.Net.WebClient
        $webClient.Headers.Add("User-Agent", "PurusWin-Installer/1.0")
        
        # Registrar evento de progresso
        Register-ObjectEvent -InputObject $webClient -EventName DownloadProgressChanged -Action {
            $percent = $Event.SourceEventArgs.ProgressPercentage
            Write-Progress -Activity "Baixando $Description" -Status "$percent% conclu√≠do" -PercentComplete $percent
        } | Out-Null
        
        $webClient.DownloadFile($Url, $OutputPath)
        $webClient.Dispose()
        
        Write-Progress -Activity "Baixando $Description" -Completed
        Write-Success "$Description baixado com sucesso!"
        return $true
    }
    catch {
        Write-Error "Falha ao baixar $Description`: $($_.Exception.Message)"
        return $false
    }
}

function Test-FileIntegrity {
    param(
        [string]$FilePath,
        [string]$HashFilePath
    )
    
    if (-not (Test-Path $HashFilePath)) {
        Write-Warning "Arquivo de hash n√£o encontrado. Pulando verifica√ß√£o de integridade."
        return $true
    }
    
    try {
        Write-Progress "Verificando integridade do arquivo..."
        
        if ($Simulate) {
            Write-Info "[SIMULA√á√ÉO] Verificaria integridade usando $HashFilePath"
            return $true
        }
        
        # Ler hash esperado
        $expectedHash = (Get-Content $HashFilePath -Raw).Trim().Split()[0].ToLower()
        
        # Calcular hash do arquivo baixado
        $actualHash = Get-FileHash256 -FilePath $FilePath
        
        if ($actualHash -eq $expectedHash) {
            Write-Success "Verifica√ß√£o de integridade passou! ‚úì"
            return $true
        } else {
            Write-Error "Verifica√ß√£o de integridade falhou!"
            Write-Error "Esperado: $expectedHash"
            Write-Error "Atual: $actualHash"
            return $false
        }
    }
    catch {
        Write-Error "Erro durante verifica√ß√£o de integridade: $($_.Exception.Message)"
        return $false
    }
}

function Install-PurusWin {
    param([string]$ZipPath, [string]$InstallPath)
    
    try {
        Write-Progress "Instalando PurusWin em $InstallPath..."
        
        if ($Simulate) {
            Write-Info "[SIMULA√á√ÉO] Extrairia $ZipPath para $InstallPath"
            return $true
        }
        
        # Limpar diret√≥rio de instala√ß√£o se existir
        if (Test-Path $InstallPath) {
            Write-Info "Removendo instala√ß√£o anterior..."
            Remove-Item $InstallPath -Recurse -Force
        }
        
        # Criar diret√≥rio de instala√ß√£o
        New-Item -ItemType Directory -Path $InstallPath -Force | Out-Null
        
        # Extrair arquivo ZIP
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($ZipPath, $InstallPath)
        
        # Verificar se o execut√°vel existe
        $exePath = Join-Path $InstallPath $script:Config.ExecutableName
        if (-not (Test-Path $exePath)) {
            Write-Error "Execut√°vel n√£o encontrado ap√≥s extra√ß√£o: $exePath"
            return $false
        }
        
        Write-Success "PurusWin instalado com sucesso em $InstallPath"
        return $true
    }
    catch {
        Write-Error "Erro durante instala√ß√£o: $($_.Exception.Message)"
        return $false
    }
}

function Add-ToSystemPath {
    param([string]$Path)
    
    try {
        Write-Progress "Adicionando $Path ao PATH do sistema..."
        
        if ($Simulate) {
            Write-Info "[SIMULA√á√ÉO] Adicionaria $Path ao PATH do sistema"
            return $true
        }
        
        # Verificar privil√©gios de administrador
        if (-not (Test-AdminPrivileges)) {
            Write-Error "Privil√©gios de administrador necess√°rios para modificar PATH do sistema"
            Write-Info "Execute o script como administrador ou use apenas para o usu√°rio atual"
            return $false
        }
        
        # Obter PATH atual do sistema
        $currentPath = [Environment]::GetEnvironmentVariable("Path", "Machine")
        
        # Verificar se j√° est√° no PATH
        if ($currentPath -split ";" | Where-Object { $_.TrimEnd('\') -eq $Path.TrimEnd('\') }) {
            Write-Info "Caminho j√° existe no PATH do sistema"
            return $true
        }
        
        # Adicionar ao PATH
        $newPath = "$currentPath;$Path"
        [Environment]::SetEnvironmentVariable("Path", $newPath, "Machine")
        
        Write-Success "Caminho adicionado ao PATH do sistema com sucesso!"
        Write-Info "Reinicie o terminal para que as mudan√ßas tenham efeito"
        return $true
    }
    catch {
        Write-Error "Erro ao adicionar ao PATH: $($_.Exception.Message)"
        return $false
    }
}

function New-DesktopShortcut {
    param(
        [string]$TargetPath,
        [string]$ShortcutName = "PurusWin"
    )
    
    try {
        Write-Progress "Criando atalho na √Årea de Trabalho..."
        
        $desktopPath = [Environment]::GetFolderPath("Desktop")
        $shortcutPath = Join-Path $desktopPath "$ShortcutName.lnk"
        
        if ($Simulate) {
            Write-Info "[SIMULA√á√ÉO] Criaria atalho em $shortcutPath"
            return $true
        }
        
        # Criar atalho usando COM
        $shell = New-Object -ComObject WScript.Shell
        $shortcut = $shell.CreateShortcut($shortcutPath)
        $shortcut.TargetPath = $TargetPath
        $shortcut.WorkingDirectory = Split-Path $TargetPath
        $shortcut.Description = "PurusWin - Ferramenta CLI para T√©cnicos de TI"
        $shortcut.Arguments = "--menu"
        $shortcut.Save()
        
        Write-Success "Atalho criado na √Årea de Trabalho: $shortcutPath"
        return $true
    }
    catch {
        Write-Error "Erro ao criar atalho: $($_.Exception.Message)"
        return $false
    }
}

function Cleanup-TempFiles {
    Write-Progress "Limpando arquivos tempor√°rios..."
    
    if ($Simulate) {
        Write-Info "[SIMULA√á√ÉO] Limparia arquivos tempor√°rios"
        return
    }
    
    @($script:Config.TempPath, $script:Config.HashTempPath) | ForEach-Object {
        if (Test-Path $_) {
            Remove-Item $_ -Force -ErrorAction SilentlyContinue
        }
    }
}

# Fun√ß√£o principal
function Main {
    # Banner
    Write-Host ""
    Write-ColorMessage "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -Color "Blue"
    Write-ColorMessage "‚ïë                    üöÄ INSTALADOR PURUSWIN üöÄ                 ‚ïë" -Color "Blue"
    Write-ColorMessage "‚ïë              Ferramenta CLI para T√©cnicos de TI              ‚ïë" -Color "Blue"
    Write-ColorMessage "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -Color "Blue"
    Write-Host ""
    
    if ($Simulate) {
        Write-Warning "MODO SIMULA√á√ÉO ATIVADO - Nenhuma altera√ß√£o ser√° feita"
        Write-Host ""
    }
    
    # Verificar se √© necess√°rio privil√©gio de administrador
    if ($AddToPath -and -not (Test-AdminPrivileges) -and -not $Simulate) {
        Write-Warning "A op√ß√£o -AddToPath requer privil√©gios de administrador"
        Write-Info "Execute o script como administrador ou remova a op√ß√£o -AddToPath"
        Write-Host ""
    }
    
    try {
        # 1. Download do arquivo principal
        Write-Info "Iniciando download do PurusWin..."
        if (-not (Download-File -Url $script:Config.DownloadUrl -OutputPath $script:Config.TempPath -Description "PurusWin.zip")) {
            throw "Falha no download do arquivo principal"
        }
        
        # 2. Download do arquivo de hash (opcional)
        Write-Info "Tentando baixar arquivo de verifica√ß√£o..."
        Download-File -Url $script:Config.HashUrl -OutputPath $script:Config.HashTempPath -Description "arquivo de hash" | Out-Null
        
        # 3. Verifica√ß√£o de integridade
        if (-not (Test-FileIntegrity -FilePath $script:Config.TempPath -HashFilePath $script:Config.HashTempPath)) {
            throw "Falha na verifica√ß√£o de integridade"
        }
        
        # 4. Instala√ß√£o
        if (-not (Install-PurusWin -ZipPath $script:Config.TempPath -InstallPath $script:Config.InstallPath)) {
            throw "Falha na instala√ß√£o"
        }
        
        # 5. Op√ß√µes adicionais
        if ($AddToPath) {
            Add-ToSystemPath -Path $script:Config.InstallPath | Out-Null
        }
        
        if ($CreateDesktopShortcut) {
            $exePath = Join-Path $script:Config.InstallPath $script:Config.ExecutableName
            New-DesktopShortcut -TargetPath $exePath | Out-Null
        }
        
        # 6. Limpeza
        Cleanup-TempFiles
        
        # 7. Mensagem final
        Write-Host ""
        Write-ColorMessage "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -Color "Green"
        Write-ColorMessage "‚ïë                   üöÄ INSTALA√á√ÉO CONCLU√çDA! üöÄ                ‚ïë" -Color "Green"
        Write-ColorMessage "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -Color "Green"
        Write-Host ""
        
        if (-not $Simulate) {
            Write-Success "PurusWin foi instalado com sucesso em: $($script:Config.InstallPath)"
            Write-Info "Execute 'PurusWin.exe --menu' para come√ßar."
            
            if ($AddToPath) {
                Write-Info "Ap√≥s reiniciar o terminal, voc√™ pode executar 'PurusWin --menu' de qualquer lugar."
            }
            
            if ($CreateDesktopShortcut) {
                Write-Info "Um atalho foi criado na sua √Årea de Trabalho."
            }
        } else {
            Write-Info "Simula√ß√£o conclu√≠da com sucesso!"
        }
        
        Write-Host ""
        
    }
    catch {
        Write-Host ""
        Write-Error "Instala√ß√£o falhou: $($_.Exception.Message)"
        Write-Info "Verifique sua conex√£o com a internet e tente novamente."
        
        # Limpeza em caso de erro
        Cleanup-TempFiles
        
        exit 1
    }
}

# Executar instala√ß√£o
Main